var VR_Share = (function () {
  var Model = (function () {
    var isMobile = /iPhone|iPad|iPod|Android|Mobile/i.test(navigator.userAgent);
    return {
      WhatsAppIcon:
        '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\x3C!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --><svg   xmlns:dc="http://purl.org/dc/elements/1.1/"   xmlns:cc="http://creativecommons.org/ns#"   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"   xmlns:svg="http://www.w3.org/2000/svg"   xmlns="http://www.w3.org/2000/svg"   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"   version="1.1"   id="Layer_1"   x="0px"   y="0px"   viewBox="0 0 308 308"   style="enable-background:new 0 0 308 308;"   xml:space="preserve"   sodipodi:docname="whatsapp-svgrepo-com.svg"   inkscape:version="0.92.1 r15371"><metadata     id="metadata40"><rdf:RDF><cc:Work         rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type           rdf:resource="http://purl.org/dc/dcmitype/StillImage" /></cc:Work></rdf:RDF></metadata><defs     id="defs38" /><sodipodi:namedview     pagecolor="#ffffff"     bordercolor="#666666"     borderopacity="1"     objecttolerance="10"     gridtolerance="10"     guidetolerance="10"     inkscape:pageopacity="0"     inkscape:pageshadow="2"     inkscape:window-width="1366"     inkscape:window-height="745"     id="namedview36"     showgrid="false"     inkscape:zoom="0.76623377"     inkscape:cx="215.33898"     inkscape:cy="154"     inkscape:window-x="-8"     inkscape:window-y="-8"     inkscape:window-maximized="1"     inkscape:current-layer="Layer_1" /><path     inkscape:connector-curvature="0"     d="m 227.904,176.981 c -0.6,-0.288 -23.054,-11.345 -27.044,-12.781 -1.629,-0.585 -3.374,-1.156 -5.23,-1.156 -3.032,0 -5.579,1.511 -7.563,4.479 -2.243,3.334 -9.033,11.271 -11.131,13.642 -0.274,0.313 -0.648,0.687 -0.872,0.687 -0.201,0 -3.676,-1.431 -4.728,-1.888 -24.087,-10.463 -42.37,-35.624 -44.877,-39.867 -0.358,-0.61 -0.373,-0.887 -0.376,-0.887 0.088,-0.323 0.898,-1.135 1.316,-1.554 1.223,-1.21 2.548,-2.805 3.83,-4.348 0.607,-0.731 1.215,-1.463 1.812,-2.153 1.86,-2.164 2.688,-3.844 3.648,-5.79 l 0.503,-1.011 c 2.344,-4.657 0.342,-8.587 -0.305,-9.856 -0.531,-1.062 -10.012,-23.944 -11.02,-26.348 -2.424,-5.801 -5.627,-8.502 -10.078,-8.502 -0.413,0 0,0 -1.732,0.073 -2.109,0.089 -13.594,1.601 -18.672,4.802 C 90,87.918 80.89,98.74 80.89,117.772 c 0,17.129 10.87,33.302 15.537,39.453 0.116,0.155 0.329,0.47 0.638,0.922 17.873,26.102 40.154,45.446 62.741,54.469 21.745,8.686 32.042,9.69 37.896,9.69 0.001,0 0.001,0 0.001,0 2.46,0 4.429,-0.193 6.166,-0.364 l 1.102,-0.105 c 7.512,-0.666 24.02,-9.22 27.775,-19.655 2.958,-8.219 3.738,-17.199 1.77,-20.458 -1.348,-2.216 -3.671,-3.331 -6.612,-4.743 z"     id="XMLID_469_"     style="fill:#ffffff" /><path     inkscape:connector-curvature="0"     d="M 156.734,0 C 73.318,0 5.454,67.354 5.454,150.143 c 0,26.777 7.166,52.988 20.741,75.928 L 0.212,302.716 c -0.484,1.429 -0.124,3.009 0.933,4.085 C 1.908,307.58 2.943,308 4,308 c 0.405,0 0.813,-0.061 1.211,-0.188 l 79.92,-25.396 c 21.87,11.685 46.588,17.853 71.604,17.853 C 240.143,300.27 308,232.923 308,150.143 308,67.354 240.143,0 156.734,0 Z m 0,268.994 c -23.539,0 -46.338,-6.797 -65.936,-19.657 -0.659,-0.433 -1.424,-0.655 -2.194,-0.655 -0.407,0 -0.815,0.062 -1.212,0.188 L 47.357,261.596 60.281,223.467 C 60.699,222.233 60.49,220.872 59.72,219.82 44.796,199.428 36.907,175.335 36.907,150.143 36.907,84.6 90.661,31.276 156.733,31.276 c 66.064,0 119.812,53.324 119.812,118.867 10e-4,65.535 -53.746,118.851 -119.811,118.851 z"     id="XMLID_470_"     style="stroke-width:50;stroke-miterlimit:4;stroke-dasharray:none;fill:#ffffff" /><g     id="g5" /><g     id="g7" /><g     id="g9" /><g     id="g11" /><g     id="g13" /><g     id="g15" /><g     id="g17" /><g     id="g19" /><g     id="g21" /><g     id="g23" /><g     id="g25" /><g     id="g27" /><g     id="g29" /><g     id="g31" /><g     id="g33" /></svg>',
      MessengerIcon:
        '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\x3C!-- Generator: Adobe Illustrator 18.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  --><svg   xmlns:dc="http://purl.org/dc/elements/1.1/"   xmlns:cc="http://creativecommons.org/ns#"   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"   xmlns:svg="http://www.w3.org/2000/svg"   xmlns="http://www.w3.org/2000/svg"   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"   version="1.1"   id="Capa_1"   x="0px"   y="0px"   viewBox="0 0 223.041 223.041"   style="enable-background:new 0 0 223.041 223.041;"   xml:space="preserve"   sodipodi:docname="facebook-messenger-logo-svgrepo-com.svg"   inkscape:version="0.92.1 r15371"><metadata     id="metadata43"><rdf:RDF><cc:Work         rdf:about=""><dc:format>image/svg+xml</dc:format><dc:type           rdf:resource="http://purl.org/dc/dcmitype/StillImage" /></cc:Work></rdf:RDF></metadata><defs     id="defs41" /><sodipodi:namedview     pagecolor="#ffffff"     bordercolor="#666666"     borderopacity="1"     objecttolerance="10"     gridtolerance="10"     guidetolerance="10"     inkscape:pageopacity="0"     inkscape:pageshadow="2"     inkscape:window-width="684"     inkscape:window-height="480"     id="namedview39"     showgrid="false"     inkscape:zoom="1.0581014"     inkscape:cx="140.81826"     inkscape:cy="111.5205"     inkscape:window-x="0"     inkscape:window-y="0"     inkscape:window-maximized="0"     inkscape:current-layer="Capa_1" /><path     inkscape:connector-curvature="0"     id="path2"     d="M 111.524,0 C 50.457,0 0.774,46.954 0.774,104.669 c 0,31.077 14.472,60.346 39.705,80.3 3.251,2.571 7.967,2.019 10.535,-1.23 2.569,-3.249 2.019,-7.966 -1.23,-10.535 -21.613,-17.092 -34.01,-42.072 -34.01,-68.534 0,-49.445 42.953,-89.67 95.75,-89.67 52.793,0 95.743,40.225 95.743,89.669 0,49.448 -42.95,89.678 -95.743,89.678 -9.209,0 -18.319,-1.223 -27.076,-3.635 -1.915,-0.528 -3.961,-0.273 -5.688,0.705 l -31.064,17.597 c -3.604,2.042 -4.871,6.618 -2.829,10.223 1.38,2.437 3.918,3.805 6.532,3.805 1.252,0 2.522,-0.314 3.689,-0.976 l 28.42,-16.099 c 9.112,2.244 18.521,3.38 28.016,3.38 61.064,0 110.743,-46.958 110.743,-104.678 C 222.267,46.954 172.588,0 111.524,0 Z"     style="fill:#ffffff" /><path     inkscape:connector-curvature="0"     id="path4"     d="m 114.67,71.85 c -2.65,-1.229 -5.772,-0.806 -8.002,1.083 l -57.89,49.056 c -3.16,2.678 -3.551,7.41 -0.873,10.57 2.678,3.16 7.411,3.551 10.57,0.873 l 45.541,-38.591 v 35.852 c 0,2.921 1.696,5.577 4.347,6.805 1.008,0.467 2.083,0.695 3.152,0.695 1.743,0 3.468,-0.607 4.85,-1.778 L 174.26,87.359 c 3.16,-2.678 3.551,-7.41 0.873,-10.571 -2.678,-3.16 -7.41,-3.552 -10.57,-0.874 l -45.547,38.593 V 78.655 c 10e-4,-2.922 -1.695,-5.577 -4.346,-6.805 z"     style="fill:#ffffff" /><g     id="g8" /><g     id="g10" /><g     id="g12" /><g     id="g14" /><g     id="g16" /><g     id="g18" /><g     id="g20" /><g     id="g22" /><g     id="g24" /><g     id="g26" /><g     id="g28" /><g     id="g30" /><g     id="g32" /><g     id="g34" /><g     id="g36" /></svg>',
      isMobile: isMobile,
      shareURI: {
        WAShare: isMobile
          ? "whatsapp://send?text={text}"
          : "https://wa.me/?text={text}",
        FBMSGShare: "fb-messenger://share/?link={link}",
      },
      appID: window.location.host,
      appToken: null,
      postUrl: null,
      shareUrl: null,
      maxShare: 5,
      isValid: false,
      postBtnText: "Go to post",
      shareAlert:
        'You must share this post to {maxShare} friends or groups in order to activate the "{post}" button below.',
    };
  })();

  var Service = (function (model) {
    var DB_TOKEN = document.location.href;
    var DB_Schema = { count: 1, time: Date.now() };
    function updateShareCount() {
      var DB = JSON.parse(localStorage.getItem(DB_TOKEN));
      if (DB) {
        ++DB.count;
      } else {
        DB = DB_Schema;
      }
      localStorage.setItem(DB_TOKEN, JSON.stringify(DB));
    }
    function getShareCount() {
      var DB = JSON.parse(localStorage.getItem(DB_TOKEN));
      return DB ? DB.count : 0;
    }
    function getShareTime() {
      var DB = JSON.parse(localStorage.getItem(DB_TOKEN));
      return DB ? DB.time || 0 : 0;
    }
    function deleteShareCount() {
      localStorage.removeItem(DB_TOKEN);
    }

    /** Validate this app using appID and appToken */
    function validateApp() {
      var token = model.appToken;
      if (token) {
        try {
          var decoded = parseJwt(token);
          var appHost = window.location.host;
          model.isValid = decoded && decoded.domain === appHost;
        } catch (error) {
          console.log(error);
        }
      }
      return model.isValid;
    }

    /** Decode Token */
    function parseJwt(token) {
      var decoded = null;
      try {
        var base64Url = token.split(".")[1];
        var base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        var jsonPayload = decodeURIComponent(
          atob(base64)
            .split("")
            .map(function (c) {
              return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
            })
            .join("")
        );
        decoded = JSON.parse(jsonPayload);
      } catch (error) {
        console.log(error);
      }
      return decoded;
    }

    function isExpiredSession() {
      var dayInMilis = 86400000;
      var shareTime = getShareTime();
      return Date.now() - shareTime > dayInMilis;
    }

    function canViewPost() {
      return getShareCount() === model.maxShare;
    }

    function enablePostBtn() {
      if (canViewPost()) {
        var postBtn = document.querySelector("#vr-post-btn");
        if (postBtn) {
          postBtn.disabled = false;
          postBtn.addEventListener("click", function (event) {
            document.location.href = model.postUrl;
          });
        }
      }
    }

    function updateProgress() {
      var progress = model.progress;
      var shareCount = getShareCount();
      var percent = (shareCount / model.maxShare) * 100;

      model.progressText.innerHTML = shareCount > 0 ? shareCount + "%" : "";
      progress.style.width = percent + "%";
    }

    return {
      updateShareCount: updateShareCount,
      getShareCount: getShareCount,
      getShareTime: getShareTime,
      deleteShareCount: deleteShareCount,
      validateApp: validateApp,
      parseJwt: parseJwt,
      canViewPost: canViewPost,
      enablePostBtn: enablePostBtn,
      updateProgress: updateProgress,
      isExpiredSession: isExpiredSession,
    };
  })(Model);

  var Controller = (function (model, service) {
    function runApp() {
      if (service.isExpiredSession()) service.deleteShareCount();
      createStyles();
      createAppElements();
      createToaster();
      service.updateProgress();
      service.enablePostBtn();
    }

    /** Create App elements */
    function createAppElements() {
      var waShareBtn = document.createElement("button");
      var msgShareBtn = document.createElement("button");
      var postBtn = document.createElement("button");
      var progressBar = document.createElement("div");
      var progress = document.createElement("div");
      var progressText = document.createElement("span");
      var shareBtnPanel = document.createElement("div");
      waShareBtn.innerHTML =
        model.WhatsAppIcon + '<span class="vr-ml-1">Share on Whatsapp</span>';
      waShareBtn.classList.add(
        "vr-share-btn",
        "vr-wa-btn",
        "vr-d-flex",
        "vr-align-items-center",
        "vr-mx-1",
        "vr-my-1"
      );
      msgShareBtn.innerHTML =
        model.MessengerIcon + '<span class="vr-ml-1">Share on Messenger</span>';
      msgShareBtn.classList.add(
        "vr-share-btn",
        "vr-msg-btn",
        "vr-d-flex",
        "vr-align-items-center",
        "vr-mx-1",
        "vr-my-1"
      );
      postBtn.id = "vr-post-btn";
      postBtn.textContent = model.postBtnText;
      postBtn.classList.add("vr-share-btn", "vr-btn-block");
      postBtn.disabled = true;
      progressBar.classList.add("vr-progress-bar", "vr-my");
      progress.classList.add("vr-progress");
      progressText.classList.add("vr-progress-text");
      shareBtnPanel.classList.add(
        "vr-d-flex",
        "vr-flex-wrap",
        "vr-align-items-center",
        "vr-justify-content-center"
      );
      var shareBtns = [waShareBtn];
      model.isMobile ? shareBtns.push(msgShareBtn) : null;
      appendChildren(shareBtnPanel, shareBtns);

      progress.appendChild(progressText);
      progressBar.appendChild(progress);
      var panel = document.querySelector("#vr-share-panel");
      var alert = createAlert(
        model.shareAlert
          .replace("{maxShare}", model.maxShare)
          .replace("{post}", model.postBtnText)
      );
      if (panel) {
        appendChildren(panel, [shareBtnPanel, progressBar, alert, postBtn]);
      }

      // Register events
      waShareBtn.addEventListener("click", shareOnWhatsApp, false);
      msgShareBtn.addEventListener("click", shareOnFBMessenger, false);

      model.waShareBtn = waShareBtn;
      model.msgShareBtn = msgShareBtn;
      model.progress = progress;
      model.progressBar = progressBar;
      model.progressText = progressText;
      model.alert = alert;
    }

    function createAlert(message) {
      var id = "vr-alert-" + Date.now();
      var alertPanel = document.createElement("div");
      alertPanel.id = id;
      alertPanel.innerHTML = message;
      alertPanel.classList.add("vr-alert");
      return alertPanel;
    }

    function createStyles() {
      var styleSheet = document.createElement("style");
      styleSheet.textContent =
        ".vr-share-btn{outline:0; padding: 0.5rem 0.5rem; border: 0.1rem solid #eee; border-radius: 0.5em; font-weight: 600; cursor: pointer; background-color: orangered; color: #fff; user-select: none; transition: all 0.2s ease-in-out; font-size: 1rem;} .vr-share-btn:active, .vr-close:active, .vr-btn:active{box-shadow: 0 0.15em 0.1rem #333; transform: translateY(-0.15em); outline: 0;} .vr-share-btn:focus{outline: 0;} .vr-share-btn[disabled] {background-color: #f79786} .vr-share-btn svg{width: 1.2em; height: 1.2em; display: inline-block;} .vr-progress-bar{width: 100%; background-color: #f3f3f3; height: 1em; border-radius: 0.75rem; position: relative; overflow: hidden;} .vr-progress{width: 0%; height: 100%; position: absolute; background-color: #71d311; border-radius: 0.75rem; display: flex; align-items: center;} #vr-share-panel{position: relative; width: 60%; margin: 0% auto;} .vr-d-flex{position: relative; display: flex; -webkit-display: flex; ms-display: flexbox;} .vr-align-items-center{align-items: center !important;} .vr-justify-content-between{justify-content: space-between;} .vr-justify-content-center{justify-content: center;} .vr-btn-block{display: inline-block !important; width: 100%;} .vr-wa-btn {background-color: #25D366; color: #fff;} .vr-wa-btn:active, .vr-wa-btn:focus{background-color: #25D366; color: #fff;} .vr-msg-btn{background-color: #00B2FF;} .vr-msg-btn:focus {background-color: #00B2FF} .vr-ml{margin-left: 0.75rem;} .vr-ml-1{margin-left: 0.4rem;} .vr-mr{margin-right: 0.75rem;} .vr-mb{margin-bottom: 0.75rem;} .vr-my{margin-top: 0.75rem; margin-bottom: 0.75rem;} .vr-mx-1{margin-left: 0.4rem; margin-right: 0.4rem;} .vr-my-1{margin-top: 0.4rem; margin-bottom: 0.4rem;} .vr-flex-wrap {flex-wrap: wrap;} .vr-toaster-panel{position: fixed; display: block; bottom: 0; left: 50%; transform: translateX(-50%); min-width: 8em; background-color: #333; color: #fff; margin: 0.33rem; border-radius: 0.75rem; box-shadow: 0 0 0.55rem #333; cursor: pointer; transition: all 0.3s ease-in-out;} .vr-toaster-panel:hover{box-shadow: 0 0 0.55rem #000} .vr-toaster-body {display: block; padding: 1rem; 0.33rem; text-align: center; font-size: 0.9rem;} .vr-toaster-panel.hide{transform: translateY(100px)} .vr-progress-text{text-align: center;display: inline-block; width: 100%; font-size: 0.75rem; padding: 0.rem;color: #333;} .vr-alert{padding: 0.75rem; margin: 0.5rem 0rem; background-color: #ffcf00; color: #2b2e30; border-radius: 0.5em; font-size: 0.9rem;}";
      var mediaQueries =
        "@media screen and (max-width: 411px){#vr-share-panel{width: 100%;}}";
      styleSheet.textContent += mediaQueries;
      document.head.appendChild(styleSheet);
    }

    function createToaster() {
      var body = document.body;
      var toasterPanel = document.createElement("div");
      var toasterBody = document.createElement("div");
      toasterPanel.classList.add("vr-toaster-panel", "hide");
      toasterBody.classList.add("vr-toaster-body");

      toasterPanel.addEventListener("click", function (event) {
        event.preventDefault();
        toasterPanel.classList.add("hide");
      });

      toasterPanel.appendChild(toasterBody);
      body.appendChild(toasterPanel);

      model.toasterPanel = toasterPanel;
      model.toasterBody = toasterBody;
    }

    function showToaster(message, timeout) {
      timeout = timeout || 2000;
      model.toasterBody.innerHTML = message;
      model.toasterPanel.classList.remove("hide");
      setTimeout(function () {
        model.toasterPanel.classList.add("hide");
      }, timeout);
    }

    function appendChildren(node, children) {
      for (var child of children) {
        node.appendChild(child);
      }
    }

    function openWindow(url, windowName, width, height) {
      var y = window.top.outerHeight / 2 + window.top.screenY - height / 2;
      var x = window.top.outerWidth / 2 + window.top.screenX - width / 2;
      var tab = window.open(
        url,
        windowName,
        `toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=no,resizable=no,copyhistory=no,width=${width},height=${height},top=${y},left=${x}`
      );

      if (!tab && model.isMobile) {
        // alert("Please disable your popup blocker and try again.");
        VR_Share.trackShare();
      }
      return tab;
    }

    function handleClose(tab) {
      if (tab) {
        var parentWindow = tab.opener;
        var intervalID = setInterval(function () {
          if (tab.closed) {
            clearInterval(intervalID);
            if (!parentWindow.closed) {
              showToaster("Shared!", 3000);
              parentWindow.VR_Share.trackShare();
            }
          }
        }, 1000);
      }
    }

    function shareOnWhatsApp() {
      if (service.canViewPost()) return showToaster("Share completed!!!", 2000);
      var url = model.shareURI.WAShare.replace("{text}", model.shareUrl);
      var tab = openWindow(url, "Share on Whatsapp", 400, 300);
      handleClose(tab);
    }

    function shareOnFBMessenger() {
      if (service.canViewPost()) return showToaster("Share completed!!!", 2000);
      var url = model.shareURI.FBMSGShare.replace("{link}", model.shareUrl);
      var tab = openWindow(url, "Share on Facebook Messenger", 400, 300);
      handleClose(tab);
    }

    return {
      runApp: runApp,
    };
  })(Model, Service);

  function init(config) {
    /** Config Check */
    if (typeof config !== "object") throw new Error("config must be an object");
    if (!config.hasOwnProperty("appToken") || config.appToken === "")
      throw new Error("appToken is missing or empty in the config object");
    if (!config.hasOwnProperty("postUrl") || config.postUrl === "")
      throw new Error("postUrl is missing or empty in the config object");
    Model.appToken = config.appToken;
    Model.maxShare = config.maxShare || 5;
    Model.shareUrl = config.shareUrl;
    Model.postUrl = config.postUrl;
    Model.postBtnText = config.postBtnText || Model.postBtnText;

    if (Service.validateApp()) Controller.runApp();
  }

  function trackShare() {
    if (Service.getShareCount() >= Model.maxShare) return;
    Service.updateShareCount();
    Service.updateProgress();
    Service.getShareCount() >= Model.maxShare ? Service.enablePostBtn() : null;
  }
  return { init: init, trackShare: trackShare };
})();
